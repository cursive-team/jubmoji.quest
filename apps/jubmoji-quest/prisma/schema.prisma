// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_PRISMA_URL") // uses connection pooling
  directUrl = env("DATABASE_URL_NON_POOLING") // uses a direct connection
}

model Card {
  id          Int     @id @default(autoincrement())
  index       Int     @unique // unique hardcoded index, separate from the autogenerated id
  name        String
  description String
  owner       String  // the owner of a card is set by whoever currently holds the card

  // Relationships
  prerequisitesFor Quest[] @relation("PrerequisiteCards")
  collectsFor      Quest[] @relation("CollectionCards")
}

model Quest {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  tags        CardTag[]
  startTime   DateTime?
  endTime     DateTime?
  proofType   ProofType
  proofParams Json    // params for the specific proof type
  imageLink   String?

  // Relationships
  prerequisiteCards Card[] @relation("PrerequisiteCards") // cards needed to see the quest
  collectionCards   Card[] @relation("CollectionCards")   // cards needed to complete the quest
  powers            Power[] // powers granted upon completion
}

model Power {
  id                     Int     @id @default(autoincrement())
  name                   String
  description            String
  startTime              DateTime?
  endTime                DateTime?
  sigNullifierRandomness String? // used if we want unique nullifiers for each power
  powerType              PowerType
  powerParams            Json    // params for the specific power type

  // Relationships
  questId       Int  
  quest         Quest   @relation(fields: [questId], references: [id])
  qrCodes       QRCode[]   
  sigNullifiers PowerSigNullifier[]
}

model QRCode {
  id                Int      @id @default(autoincrement())
  uuid              String   @unique @default(uuid()) 
  serializedProof   String   

  // Relationships
  powerId   Int      
  power     Power    @relation(fields: [powerId], references: [id]) 
}

model PowerSigNullifier {
  id        Int    @id @default(autoincrement())
  nullifier String 
  
  // Relationships
  powerId   Int   
  power     Power  @relation(fields: [powerId], references: [id])

  // Indexes
  @@index([powerId], name: "powerId_idx") 

  // Constraints
  @@unique([nullifier, powerId])
}

enum CardTag {
  OFFICIAL
  ROLES
  APPLICATIONS
  COMMUNITY
  DEV_TOOLS
  INFRASTRUCTURE
  PRIVACY
  PERSONAL
}

enum ProofType {
  IN_COLLECTION
  IN_COLLECTION_NONCE
  N_UNIQUE_IN_COLLECTION
}

enum PowerType {
  QR_CODE
  TELEGRAM
  TWITTER
}